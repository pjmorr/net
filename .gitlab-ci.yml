# This file is generated by UberMonitoring ModuleSync, do not edit.
---
image: ruby:2.3.1

stages:
- prebuild
- test
- build
- review
- release
- pages
variables:
  GIT_STRATEGY: clone
  CONTROL_REPO: $CONTRL_REPO
  TOKEN: $TOKEN
  AWS_ACCESS_KEY_ID: $UBEROPS_AWS_ACCESS_KEY_ID
  AWS_SECRET_ACCESS_KEY: $UBEROPS_AWS_SECRET_ACCESS_KEY
  AWS_DEFAULT_REGION: us-east-1
  S3_BUCKET: $S3_BUCKET
  S3_KEY: $S3_KEY
cache:
  key: $CI_PROJECT_PATH
  paths:
  - .bundle
  - node_modules
before_script:
  - source ci/prepare
checks:
  only:
  - branches
  stage: test
  script:
  - source ci/checks
  artifacts:
    paths:
    - .bundle/
  tags:
  - aws
.build: &build-template
  image: docker:1.12.2-git
  services: ["docker:dind"]
  variables:
    DOCKER_DRIVER: overlay
  stage: build
  before_script:
    - source ci/dockerprescript
  script:
    - source ci/build
  dependencies:
  - checks
  artifacts:
    paths:
    - ./
  tags:
  - docker
Development:
  <<: *build-template
  only:
  - branches
  except:
  - master@cogbundles/net
  - tags@cogbundles/net
Staging:
  <<: *build-template
  only:
  - master@cogbundles/net
  environment: staging
Stable:
  <<: *build-template
  variables:
    RELEASE: "true"
  only:
  - tags@cogbundles/net
  - /*-stable@cogbundles/net
  environment: staging
pages:
  image: ruby:2.3
  stage: pages
  script:
  - gem install jekyll
  - jekyll build -d public/
  artifacts:
    paths:
    - public
  tags:
  - aws
  only:
  - pages

.release: &release
  stage: release
  before_script:
  - source ci/prepare
  script:
  - source ci/deploy $CI_BUILD_NAME
  - "curl -k -X POST -F token=$TOKEN -F ref=$CI_BUILD_REF_NAME https://$GITLAB_SERVER/api/v3/projects/$CONTRL_REPO/trigger/builds"
  artifacts:
    paths:
    - ./
    expire_in: 7d
  tags:
  - release

development:
  <<: *release
  only:
  - branches@cogbundles/net
  except:
  - master@cogbundles/net
  environment: development

bleeding:
  <<: *release
  only:
  - master@cogbundles/net
  - /\Av[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+\Z/@cogbundles/net
  environment: bleeding_edge

stable:
  <<: *release
  only:
  - /\Av[0-9]+\.[0-9]+\.[0-9]+\Z/@/
  - /\A[0-9]+\-[0-9]\-stable\Z/@/
  - production@cogbundles/net
  environment: stable_release

production:
  <<: *release
  only:
  - production@cogbundles/net
  environment: production
