# This file is generated by UberMonitoring ModuleSync, do not edit.
---
image: ruby:2.3.1

stages:
- test
- build
- review
- release
- cleanup
- pages
variables:
  GIT_STRATEGY: clone
  TOKEN: $TOKEN
  AWS_ACCESS_KEY_ID: $UBEROPS_AWS_ACCESS_KEY_ID
  AWS_SECRET_ACCESS_KEY: $UBEROPS_AWS_SECRET_ACCESS_KEY
  AWS_DEFAULT_REGION: us-east-1
  S3_BUCKET: $S3_BUCKET
  S3_KEY: $S3_KEY
  IMAGE: registry.ubermonitoring.com:4567/cogbundles/net
cache:
  key: $CI_PROJECT_PATH
  paths:
  - .bundle
before_script:
  - source ci/prepare
checks:
  only:
  - branches
  stage: test
  script:
  - source ci/checks
  artifacts:
    paths:
    - .bundle/
  tags:
  - aws
.build: &build-template
  image: docker:1.12.2-git
  services: ["docker:dind"]
  variables:
    DOCKER_DRIVER: overlay
  stage: build
  before_script:
    - source ci/dockerprescript
  script:
    - source ci/build
  dependencies:
  - checks
  artifacts:
    paths:
    - ./
  expire_in: 7d
  tags:
  - docker
development:
  <<: *build-template
  only:
  - branches
  except:
  - master@cogbundles/net
  - tags@cogbundles/net
  - production@cogbundles/net
production:
  <<: *build-template
  only:
  - production@cogbundles/net
  environment: production
staging:
  <<: *build-template
  variables:
    RELEASE: "true"
  only:
  - tags@cogbundles/net
  environment: staging
cleanup:
  only:
  - branches
  stage: cleanup
  before_script:
  - source ci/cleanup
  script:
  - source ci/cleanup
  tags:
  - aws
pages:
  image: ruby:2.3
  stage: pages
  script:
  - gem install jekyll
  - jekyll build -d public/
  artifacts:
    paths:
    - public
  tags:
  - aws
  only:
  - pages

.release: &release
  stage: release
  before_script:
  - source ci/prepare
  script:
  - echo "This will run cogctl commands soon"
  artifacts:
    paths:
    - ./
    expire_in: 7d
  tags:
  - release

development:
  <<: *release
  only:
  - branches@cogbundles/net
  except:
  - master@cogbundles/net
  environment: development

staging:
  <<: *release
  only:
  - master@cogbundles/net
  - /\Av[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+\Z/@cogbundles/net
  environment: staging

stable:
  <<: *release
  only:
  - /\Av[0-9]+\.[0-9]+\.[0-9]+\Z/@cogbundles/net
  - /\A[0-9]+\-[0-9]\-stable\Z/@cogbundles/net
  environment: stable_release

production:
  <<: *release
  only:
  - production@cogbundles/net
  environment: production
